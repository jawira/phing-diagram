#!/usr/bin/env php
<?php

namespace Jawira\PhingVisualizer;

use Throwable;


/**
 * Return autoload's location
 *
 * @return string
 * @throws \Jawira\PhingVisualizer\DiagramException
 */
function autoloadPath(): string
{
    $autoloadFiles = [
        __DIR__ . '/../vendor/autoload.php',
        __DIR__ . '/../../../autoload.php',
    ];

    foreach ($autoloadFiles as $file) {
        if (file_exists($file)) {
            return $file;
        }
    }

    throw new DiagramException("Autoload file not found; try 'composer dump-autoload' first.");
}

/**
 * Generate diagram
 *
 * @throws \Jawira\PhingVisualizer\DiagramException
 * @throws \Exception
 */
function saveDiagram(): void
{
    $options = getopt('i:o:f:h', ['input:', 'output:', 'format:', 'help']);

    $help   = $options['h'] ?? $options['help'] ?? null;
    $input  = $options['i'] ?? $options['input'] ?? null;
    $output = $options['o'] ?? $options['output'] ?? null;
    $format = $options['f'] ?? $options['format'] ?? null;

    if (false === $help) {
        help();
        exit(0);
    }

    if (null === $input) {
        throw new DiagramException('Input file is required.');
    }

    if (null === $format) {
        throw new DiagramException('Format is required.');
    }

    $diagram = new Diagram($input);
    $diagram->save($format, $output);
}

/**
 * Show binary help
 */
function help()
{
    echo <<<'HELP'
NAME
    phing-visualizer - visualize Phing's buildfile

SYNOPSIS
    foo -i <buildfile> -f <png|svg|puml> [-o <diagram-path>] 

DESCRIPTION
    With phing-visualizer you can generate a diagram that 
    represents Phing's targets calls and dependencies.

OPTIONS
    -i, --input <buildfile>
        The buildfile location. It could be an absolute or 
        relative path.
    
    -f, --format <png|svg|puml>
        The format of the diagram to generate. 
    
    -o, --output <diagram-path>
        The location for the diagram to be generated, it could 
        be a filepath or dirpath. It defaults to same location 
        as --input.
    -h, --help
        Shows this message.

EXAMPLE
    $ phing-visualizer -i build.xml -f png -o images/
    $ phing-visualizer --input /projects/build.xml --format svg
    
AUTHOR
    Jawira Portugal


HELP;
}

/**
 * Main function
 */
function main(): void
{
    try {
        /** @noinspection PhpIncludeInspection */
        require autoloadPath();
        saveDiagram();
    } catch (Throwable $th) {
        exit('âš  ' . $th->getMessage() . PHP_EOL);
    }
}

main();
